<?php
/**
  @file
  @brief Defines the Simple Table theme function.
*/

/// Implements hook_theme ().
function simple_table_theme ($existing, $type, $theme, $path) {
  return array (
    'simple_table' => array (
      'render element' => '#simple_table',
  ));
}

/**
  @brief Implements theme_callback ().
  @details
    Accepts a render array that represents a simple
    table and returns an HTML string that
    represents the table.
  @note The render array must have the following
    structure:
    array ('#simple_table' =>
      array ('caption' => <caption>,
             'column_names' => array (<column name>, ...),
             'rows' => array (array (<field value>, ...), ...))
*/
function theme_simple_table (&$vars) {
  $table = $vars ['#simple_table'];

  $html = '<table><caption>' . $table ['caption'] . '</caption><thead><tr>';
  foreach ($table ['column_names'] as $column_name) {
    $html .= '<th>' . $column_name . '</th>';
  }
  $html .= '</tr></thead><tbody>';
  foreach ($table ['rows'] as $row) {
    $html .= '<tr>';
    foreach ($row as $field) {
      $html .= '<td>' . $field . '</td>';
    }
    $html .= '</tr>';
  }
  return $html . '</tbody></table>';
}

/**
  @brief Accepts a field values array and returns a
    render array that represents a table containing
    them.
  @param $data (array) the data array.
  @return (array) the render array.
  @note
    The data array must have the following
    form:
    array (
      'caption' => <caption>
      'columns' => array (
        'column_name' => <column name>,
        'weight'      => <weight>,
      ),
      'sort_column' => <column name>,
      'fields' => array (
         array ('column_name' => <column name>,
                'row_name'    => <row name>,
                'value'       => <field value>),
           ...
      ),
      'default_field_value_function => <callback (column_name, row_name) -> field_value>
    );
*/
function simple_table ($data) {

  $columns = isset ($data ['columns']) ? $data ['columns'] : array ();

  usort ($columns,
    create_function ('$x, $y', 'return $x [\'weight\'] > $y [\'weight\'];'));  

  $column_names = array_map (
    create_function ('$column', 'return $column [\'column_name\'];'),
    $columns);

  $fields = isset ($data ['fields']) ? $data ['fields'] : array ();

  $rows = array ();
  foreach ($fields as $field) {
    $column_names [] = $field ['column_name'];
    $rows [$field ['row_name']][$field ['column_name']] = $field ['value'];
  }

  $column_names = array_unique ($column_names);

  if (isset ($data ['sort_column'])) {
    usort ($rows,
      create_function ('$x, $y', 'return $x [\'' . $data ['sort_column'] . '\'] < $y [\'' . $data ['sort_column'] . '\'];'));
  }

  $table = array (
    'caption'      => isset ($data ['caption']) ? $data ['caption'] : '',
    'column_names' => $column_names,
    'rows'         => array ()
  );

  foreach ($rows as $row_name => $row) {
    $table_row = array ();
    foreach ($column_names as $column_name) {
      $table_row [] = isset ($row [$column_name]) ?
                        $row [$column_name] :
                        (isset ($data ['default_field_value_function']) ?
                           call_user_func ($data ['default_field_value_function'], $column_name, $row_name) :
                           '');
    }
    $table ['rows'][] = $table_row;
  }

  return array ('#simple_table' => $table);
}

/// The AJAX callback for the sort buttons in the Simple Table form.
function _simple_table_sort () {
  watchdog (
    'simple_table',
    '[_simple_table_sort]'
  );

  list ($form, $form_state) = ajax_get_form();

  $_SESSION ['simple_table']['data']['sort_column'] = 
    $form_state ['input']['_triggering_element_value'];

  watchdog (
    'simple_table',
    '[_simple_table_sort] form state: <pre>@form_state</pre>',
    array (
      '@form_state' => print_r ($form_state, true)
  ));

  return drupal_get_form ('simple_table_form');
}

/**
  @brief Returns a form that embeds a table.
  @return (array) the table data array.
  @note The data array must be defined in
    $_SESSION ['simple_table']['data'].
*/
function simple_table_form ($form, $form_state) {
  if (!isset ($_SESSION ['simple_table']['data'])) {
    return array ();
  }

  $data = $_SESSION ['simple_table']['data'];
  
  $table = simple_table ($data);
  $table = $table ['#simple_table'];

  $form = array (
    'table' => array (
      '#type'   => 'container',
      '#prefix' => '<div id=\'simple_table\'><table><caption>' . $table ['caption'] . '</caption>',
      'header'  => array (
        '#type'   => 'container',
        '#prefix' => '<thead><tr>',
        '#suffix' => '</tr></thead>'
      ),
      'body'    => array (
        '#type'   => 'container',
        '#prefix' => '<tbody>',
        '#suffix' => '</tbody>'
      ),
      '#suffix' => '</table></div>'
  ));
  $column_offset = 0;
  $sort_column_offset = null;
  foreach ($table ['column_names'] as $column_name) {
    $is_sort_column = isset ($data ['sort_column']) && $column_name == $data ['sort_column'];
    if ($is_sort_column) {
      $sort_column_offset = $column_offset;
    }
    $column_element = array (
      '#type'   => 'button',
      '#prefix' => $is_sort_column ? '<th class="simple_table_sort_column_header">' : '<th>',
      '#suffix' => ($is_sort_column ? '<img id="simple_table_sort_icon" src="' . url (drupal_get_path ('module', 'simple_table') . '/desc_sort_icon.png') . '">' : '') . '</th>',
      '#value'  => $column_name,
      'column_name' => array (
        '#type'  => 'hidden',
        '#value' => $column_name
      ),
      '#ajax' => array (
        'callback' => '_simple_table_sort',
        'wrapper'  => 'simple_table'
      )
    );

    $form ['table']['header'][] = $column_element;
    $column_offset ++;
  }
  foreach ($table ['rows'] as $row) {
    $row_elem = array (
      '#prefix' => '<tr>',
      '#suffix' => '</tr>'
    );
    $field_offset = 0;
    foreach ($row as $field) {
      $is_sort_field = !is_null ($sort_column_offset) && $field_offset == $sort_column_offset;
      $field_elem = array (
        '#prefix' => $is_sort_field ? '<td class="simple_table_sort_column_field">' : '<td>',
        '#suffix' => '</td>',
        '#markup' => $field
      );
      $row_elem [] = $field_elem;
      $field_offset ++;
    }
    $form ['table']['body'][] = $row_elem;
  }
  return $form;
}
