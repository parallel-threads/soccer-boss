<?php
/**
  @file
*/

/**
  @brief Accepts a user account and a role and
    returns true iff the user has the given role.
  @param $account (user) the user account.
  @param $role (string) the user role.
  @return (boolean).
*/
function _soccer_boss_has_role ($account, $role = 'authenticated user') {
  return in_array ($role, $account->roles);
}

/**
  @brief Implements hook_node_access ().
  @details Deny all access to unauthenticated users.
*/
function soccer_boss_node_access ($node, $op, $account) {
  module_load_include ('inc', 'soccer_boss');
  if (!_soccer_boss_has_role ($account)) {
    return NODE_ACCESS_DENY;
  }
  return NODE_ACCESS_IGNORE;
}

/// Implements hook_view_api ().
function soccer_boss_views_api () {
  return array ('api' => 3.0);
}

/**
  @brief Accepts a conditions array and returns
    true iff the conditions are satisfied in the
    current context.
  @note This function is used to control page
    access.
  @note The conditions array must have the
    following structure:
    array (
      'type'        => <node type>,              // optional. Requires that the current node has the given type.
      'roles'       => array (<role name>),      // optional. Requires that the user have one of the given roles.
      'permissions' => array (<permission name>) // optional. Requires that the user have all of the given permissions.
    )
*/
function _soccer_boss_access ($conditions) {
  // I. Check content type.
  $node = node_load (arg (1));
  if (isset ($conditions ['type'])) {
    if (is_null ($node) || $node->type != $conditions ['type']) {
      return false;
    }
  }

  // II. Check user roles.
  global $user;
  if (isset ($conditions ['roles'])) {
    $hasRole = false;
    foreach ($conditions ['roles'] as $role) {
      if (_soccer_boss_has_role ($user, $role)) {
        $hasRole = true;
        break;
      }
    }
    if (!$hasRole) {
      return false;
    }
  }

  // III. Check user permissions.
  if (isset ($conditions ['permissions'])) {
    foreach ($conditions ['permissions'] as $permission) {
      if (!user_access ($permission, $user)) {
        return false;
      }
    }
  }

  // IV. Grant access.
  return true;
}

/// Implements hook_menu ().
function soccer_boss_menu () {
  module_load_include ('inc', 'soccer_boss');
  return array (
    // I. Player pages.
    'node/%node/team' => array (
      'title'            => t ('Team'),
      'description'      => t ('Redirects the user to the player\'s team page.'),
      'access callback'  => '_soccer_boss_access',
      'access arguments' => array (array (
                              'type'  => soccer_boss_PLAYER_TYPE,
                              'roles' => array ('authenticated user', 'administrator')
                            )),
      'page callback'    => 'soccer_boss_player_team_page',
      'page arguments'   => array (1),
      'type'             => MENU_LOCAL_TASK,
      'file'             => 'soccer_boss.page.inc',
      'weight'           => 1
    ),
    'player-comparison/%/%' => array (
      'title'            => t ('Player Comparison'),
      'description'      => t ('Displays two players side-by-side for comparison.'),
      'access callback'  => '_soccer_boss_access',
      'access arguments' => array (array (
                              'roles' => array ('authenticated user', 'administrator')
                            )),
      'page callback'    => 'soccer_boss_player_comparison',
      'page arguments'   => array (1, 2),
      'type'             => MENU_CALLBACK,
      'file'             => 'soccer_boss.page.inc',
    ),
    'node/%node/fitness' => array (
      'title'            => t ('Player Fitness'),
      'description'      => t ('Displays the player fitness stats.'),
      'access callback'  => '_soccer_boss_access',
      'access arguments' => array (array (
                              'type'  => soccer_boss_PLAYER_TYPE,
                              'roles' => array ('authenticated user', 'administrator')
                            )),
      'page callback'    => 'soccer_boss_player_fitness_page',
      'page arguments'   => array (1),
      'type'             => MENU_LOCAL_TASK,
      'file'             => 'soccer_boss.page.inc',
      'weight'           => 6
    ),
    'node/%node/player-game-stats' => array (
      'title'            => t ('Player Game Stats'),
      'description'      => t ('Displays the player game stats.'),
      'access callback'  => '_soccer_boss_access',
      'access arguments' => array (array (
                              'type'  => soccer_boss_PLAYER_TYPE,
                              'roles' => array ('authenticated user', 'administrator')
                            )),
      'page callback'    => 'soccer_boss_player_game_stats_page',
      'page arguments'   => array (1),
      'type'             => MENU_LOCAL_TASK,
      'file'             => 'soccer_boss.page.inc',
      'weight'           => 7
    ),
    // II. Team pages.
    'team-comparison' => array (
      'title'            => t ('Team Comparison'),
      'description'      => t ('Displays two teams side-by-side for comparison.'),
      'access callback'  => '_soccer_boss_access',
      'access arguments' => array (array (
                              'roles' => array ('authenticated user', 'administrator')
                            )),
      'page callback'    => 'soccer_boss_team_comparison',
      'page arguments'   => array (1, 2),
      'type'             => MENU_CALLBACK,
      'file'             => 'soccer_boss.page.inc',
    ),
    'node/%node/team-player-game-stats' => array (
      'title'            => t ('Player Game Stats'),
      'description'      => t ('Displays the game stats for each player on the team.'),
      'access callback'  => '_soccer_boss_access',
      'access arguments' => array (array (
                              'type'  => soccer_boss_TEAM_TYPE,
                              'roles' => array ('authenticated user', 'administrator')
                            )),
      'page callback'    => 'soccer_boss_team_player_game_stats_page',
      'page arguments'   => array (1),
      'type'             => MENU_LOCAL_TASK,
      'file'             => 'soccer_boss.page.inc'
    ),
    'node/%node/add-team-player-stats' => array (
      'title'            => t ('Add Player Performance Stats'),
      'description'      => t ('Displays a form in which player performance stats can be added.'),
      'access callback'  => '_soccer_boss_access',
      'access arguments' => array (array (
                              'type'  => soccer_boss_TEAM_TYPE,
                              'roles' => array (
                                           soccer_boss_TEAM_STAFF_ROLE,
                                           soccer_boss_CLUB_STAFF_ROLE,
                                           soccer_boss_DIRECTOR_ROLE,
                                           'administrator'
                            ))),
      'page callback'    => 'drupal_get_form',
      'page arguments'   => array ('soccer_boss_team_player_stats_form', 1),
      'type'             => MENU_LOCAL_TASK,
      'file'             => 'soccer_boss.page.inc',
    ),
    'node/%node/add-team-player-game-stats' => array (
      'title'            => t ('Add Player Game Stats'),
      'description'      => t ('Displays a form to enter player game stats.'),
      'access callback'  => '_soccer_boss_access',
      'access arguments' => array (array (
                              'type'  => soccer_boss_TEAM_TYPE,
                              'roles' => array (
                                           soccer_boss_TEAM_STAFF_ROLE,
                                           soccer_boss_CLUB_STAFF_ROLE,
                                           soccer_boss_DIRECTOR_ROLE,
                                           'administrator'
                            ))),
      'page callback'    => 'drupal_get_form',
      'page arguments'   => array ('soccer_boss_team_player_game_stats_form', 1),
      'type'             => MENU_LOCAL_TASK,
      'file'             => 'soccer_boss.page.inc'
    ),
    'player-comparison-form' => array (
      'title'            => t ('Player Comparison'),
      'description'      => t ('Lets users select players to compare.'),
      'access callback'  => '_soccer_boss_access',
      'access arguments' => array (array (
                              'roles' => array ('authenticated user', 'administrator')
                            )),
      'page callback'    => 'drupal_get_form',
      'page arguments'   => array ('soccer_boss_player_comparison_form'),
      'type'             => MENU_NORMAL_ITEM
    ),
    'team-comparison-form' => array (
      'title'            => t ('Team Comparison'),
      'description'      => t ('Lets users select teams to compare.'),
      'access callback'  => '_soccer_boss_access',
      'access arguments' => array (array (
                              'roles' => array ('authenticated user', 'administrator')
                            )),
      'page callback'    => 'drupal_get_form',
      'page arguments'   => array ('soccer_boss_team_comparison_form'),
      'type'             => MENU_NORMAL_ITEM
    ),
    'team-player-stats-form/%' => array (
      'title'            => t ('Team Player Stats'),
      'description'      => t ('The Team Player Stats form.'),
      'access callback'  => '_soccer_boss_access',
      'access arguments' => array (array (
                              'roles' => array ('authenticated user', 'administrator')
                            )),
      'page callback'    => 'drupal_get_form',
      'page arguments'   => array ('soccer_boss_team_player_stats_form', 1),
      'type'             => MENU_NORMAL_ITEM
    ),
    'node/%node/add-player-fitness-stats' => array (
      'title'            => t ('Add Player Fitness Stats'),
      'description'      => t ('Displays a form in which a player can add fitness stats.'),
      'access callback'  => '_soccer_boss_access',
      'access arguments' => array (array (
                              'type'  => soccer_boss_PLAYER_TYPE,
                              'roles' => array (
                                           soccer_boss_TEAM_STAFF_ROLE,
                                           soccer_boss_CLUB_STAFF_ROLE,
                                           soccer_boss_DIRECTOR_ROLE,
                                           'administrator'
                            ))),
      'page callback'    => 'drupal_get_form',
      'page arguments'   => array ('soccer_boss_pfs_form', 1),
      'type'             => MENU_LOCAL_TASK
    )
  );
}

// ----- II. Comparison Forms ----- 

/**
  @brief
    Returns the Player Comparison form. The form is
    used to select players to compare on the player
    comparison page.
*/
function soccer_boss_player_comparison_form ($form, &$form_state) {
  module_load_include ('inc', 'soccer_boss');

  return array (
    'player_x' => array (
      '#type'            => 'entityreference',
      '#title'           => t ('First Player'),
      '#era_entity_type' => 'node',
      '#era_bundles'     => array (soccer_boss_PLAYER_TYPE),
      '#era_cardinality' => 1
    ),
    'player_y' => array (
      '#type'            => 'entityreference',
      '#title'           => t ('Second Player'),
      '#era_entity_type' => 'node',
      '#era_bundles'     => array (soccer_boss_PLAYER_TYPE),
      '#era_cardinality' => 1
    ),
    'submit' => array (
      '#type'  => 'submit',
      '#value' => 'Compare!'
    )
  );
}

/**
  @brief Processes a Player Comparison Form
    submission and redirects the user to the Player
    Comparison Page.
*/
function soccer_boss_player_comparison_form_submit ($form, &$form_state) {
  drupal_goto ('player-comparison/' . 
    $form_state ['values']['player_x']['entity_id'] . '/' .
    $form_state ['values']['player_y']['entity_id']
  );
}

/**
  @brief
    Returns the Team Comparison form. The form is
    used to select teams to compare on the Team 
    Comparison page.
*/
function soccer_boss_team_comparison_form ($form, &$form_state) {
  module_load_include ('inc', 'soccer_boss');

  return array (
    'team_x' => array (
      '#type'            => 'entityreference',
      '#title'           => t ('First Team'),
      '#era_entity_type' => 'node',
      '#era_bundles'     => array (soccer_boss_TEAM_TYPE),
      '#era_cardinality' => 1
    ),
    'team_y' => array (
      '#type'            => 'entityreference',
      '#title'           => t ('Second Team'),
      '#era_entity_type' => 'node',
      '#era_bundles'     => array (soccer_boss_TEAM_TYPE),
      '#era_cardinality' => 1
    ),
    'submit' => array (
      '#type'  => 'submit',
      '#value' => 'Compare!'
    )
  );
}

/**
  @brief Processes a Team Comparison Form
    submission and redirects the user to the Team
    Comparison Page.
*/
function soccer_boss_team_comparison_form_submit ($form, &$form_state) {
  drupal_goto ('team-comparison/' . 
    $form_state ['values']['team_x']['entity_id'] . '/' .
    $form_state ['values']['team_y']['entity_id']
  );
}

// ----- III. Stat Sheets -----

/**
  @brief Creates a stat sheet organized into a spreadsheet
  @param $info (array) the spreadsheet description.
  @note $info has the following structure:
    array (
      'columns'  => array (<stat name> => <header label>, ...)
      'entities' => array (<entity>, ...)
    )
*/
function soccer_boss_create_stat_sheet ($info) {
  // I. Define the table headers.
  $prefix = '<table><thead><tr><th>Name</th>';
  foreach (array_values ($info ['columns']) as $label) {
    $prefix .= "<th>$label</th>";
  }
  $prefix .= '</tr></thead><tbody>';

  $form = array (
    '#prefix'     => $prefix,
    '#suffix'     => '</tbody></table>',
    '#attributes' => array (
      'class' => array ('statsheet-table')
    )
  );

  // II. Define the table rows.
  foreach ($info ['entities'] as $entity) {
    $entity_id    = entity_id    ('node', $entity);
    $entity_label = entity_label ('node', $entity);
    $entity_uri   = entity_uri   ('node', $entity);

    // II.A. Define the table row.
    $form [$entity_id . '_row'] = array (
      '#prefix'     => '<tr><td>' . l ($entity_label, $entity_uri ['path']) . '</td>',
      '#suffix'     => '</tr>',
      '#attributes' => array (
        'class' => array ('statsheet-row')
      )
    );

    // II.B. Define table cells.
    foreach (array_keys ($info ['columns']) as $stat_name) {
      $form [$entity_id . '_row'][$entity_id . '_' . $stat_name] = array (
        '#prefix'     => '<td>',
        '#suffix'     => '</td>',
        '#type'       => 'textfield',
        '#attributes' => array (
          'class' => array ('statsheet-cell')
        )
      ); 
    }
  }

  $form ['submit'] = array (
    '#type'  => 'submit',
    '#value' => 'Save'
  );

  return $form;
}

/**
  @brief Accepts a stat sheet form and creates
    stats for the values listed in the form.
  @param $form_values (array) the form values.
*/
function soccer_boss_process_stat_sheet ($info, $form_values) {
  $values = array ();
  foreach ($info ['entities'] as $entity) {
    $entity_id = entity_id ('node', $entity);

    foreach ($form_values as $key => $value) {
      if (0 === strpos ($key, $entity_id, 0) && $value !== '') {
        $i = strpos ($key, '_', 0);
        $stat_name = substr ($key, $i + 1);
        $values [$entity_id][$stat_name] = array (
          'label' => $info ['columns'][$stat_name],
          'value' => $value
        );
      }
    }
  }
  return $values;
}

/**
  @brief Creates the Team Player Stats form.
  @param $form (array) the initial form.
  @param $form_state (array) the initial form state.
  @param $team (node) the team node.
  @return (array) the form array.
*/
function soccer_boss_team_player_stats_form ($form, &$form_state, $team) {
  module_load_include ('inc', 'soccer_boss');

  $player_nids = soccer_boss_get_references (
    $team->nid,
    'node',
    'soccer_boss_player_team'
  );

  $info = array (
    'columns' => array (
      'goals'         => 'Goals',
      'assists'       => 'Assists',
      'shots'         => 'Shots',
      'goal_shots'    => 'Shots on Goal',
      'yellow_cards'  => 'Yellow Cards',
      'red_cards'     => 'Red Cards',
      'shutouts'      => 'Shutouts',
      'saves'         => 'Saves'
    ),
    'entities' => node_load_multiple ($player_nids)
  );

  $form_state ['soccer_boss_info'] = $info;

  $form = array (
    'year' => array (
      '#type'            => 'textfield',
      '#title'           => t ('Year'),
      '#required'        => true
  ));
  $form += soccer_boss_create_stat_sheet ($info);
  return $form;
}

/**
  @brief Processes the Team Player Stats form.
*/
function soccer_boss_team_player_stats_form_submit ($form, $form_state) {
  $values = soccer_boss_process_stat_sheet (
    $form_state ['soccer_boss_info'],
    $form_state ['values']
  );

  foreach ($values as $entity_id => $stat_values) {
    foreach ($stat_values as $stat_name => $stat_value) {
      $node = new stdClass ();
      $node->type = soccer_boss_PPS_TYPE;
      node_object_prepare ($node);

      $node->title = $stat_value ['label'];
      $node->soccer_boss_pps_player ['und'][0]['target_id'] = $entity_id;
      $node->soccer_boss_pps_year   ['und'][0] = array (
        'value'  => $form_state ['values']['year'],
        'format' => 'plain_text'
      );
      $node->soccer_boss_pps_value  ['und'][0] = array (
        'value'  => $stat_value ['value'],
        'format' => 'plain_text'
      );

      node_save ($node);
    }
  }
}

/**
  @brief Creates the Team Player Game Stats form.
  @param $form (array) the initial form.
  @param $form_state (array) the initial form state.
  @param $team (node) the team node.
  @return (array) the form array.
*/
function soccer_boss_team_player_game_stats_form ($form, &$form_state, $team) {
  module_load_include ('inc', 'soccer_boss');

  $player_nids = soccer_boss_get_references (
    $team->nid,
    'node',
    'soccer_boss_player_team'
  );

  $info = array (
    'columns' => array (
      'goals'         => 'Goals',
      'assists'       => 'Assists',
      'shots'         => 'Shots',
      'goal_shots'    => 'Shots on Goal',
      'yellow_cards'  => 'Yellow Cards',
      'red_cards'     => 'Red Cards',
      'shutouts'      => 'Shutouts',
      'saves'         => 'Saves'
    ),
    'entities' => node_load_multiple ($player_nids)
  );

  $form_state ['soccer_boss_info'] = $info;

  $form = array (
    'game' => array (
      '#type'            => 'entityreference',
      '#title'           => t ('Game'),
      '#era_entity_type' => 'node',
      '#era_bundles'     => array (soccer_boss_GAME_TYPE),
      '#era_cardinality' => 1
  ));
  $form += soccer_boss_create_stat_sheet ($info);
  return $form;
}

/**
  @brief Processes the Team Player Game Stats form.
*/
function soccer_boss_team_player_game_stats_form_submit ($form, $form_state) {
  $values = soccer_boss_process_stat_sheet (
    $form_state ['soccer_boss_info'],
    $form_state ['values']
  );

  foreach ($values as $entity_id => $stat_values) {
    foreach ($stat_values as $stat_name => $stat_value) {
      $node = new stdClass ();
      $node->type = soccer_boss_PGS_TYPE;
      node_object_prepare ($node);

      $node->title = $stat_value ['label'];
      $node->soccer_boss_pgs_player ['und'][0]['target_id'] = $entity_id;
      $node->soccer_boss_pgs_game   ['und'][0]['target_id'] = $form_state ['values']['game']['entity_id'];
      $node->soccer_boss_pgs_value  ['und'][0] = array (
        'value'  => $stat_value ['value'],
        'format' => 'plain_text'
      );

      node_save ($node);
    }
  }
}

/**
  @brief Defines the Player Fitness Stats form.
*/
function soccer_boss_pfs_form ($form, $form_state, $player_node) {
  return array (
    'player' => array (
      '#type'  => 'value',
      '#value' => $player_node->nid
    ),
    'date' => array (
      '#type'          => 'textfield',
      '#title'         => t ('Date'),
      '#description'   => t ('The Date on which these stats were measured or applied.'),
      '#default_value' => date ('D, d M Y H:i:s'),
      '#required'      => true
    ),
    'mile_time' => array (
      '#type'  => 'textfield',
      '#title' => t ('Mile Time')
    ),
    'two_mile_time' => array (
      '#type'  => 'textfield',
      '#title' => t ('Two Mile Time')
    ),
    'beep_test' => array (
      '#type'  => 'textfield',
      '#title' => t ('Beep Test')
    ),
    'dash_time' => array (
      '#type'  => 'textfield',
      '#title' => t ('60 yard dash time')
    ),
    'push_ups' => array (
      '#type'  => 'textfield',
      '#title' => t ('Push-Ups per Minute')
    ),
    'sit_ups' => array (
      '#type'  => 'textfield',
      '#title' => t ('Sit-Ups per Minute')
    ),
    'bench_press' => array (
      '#type'  => 'textfield',
      '#title' => t ('Bench press')
    ),
    'squat' => array (
      '#type'  => 'textfield',
      '#title' => t ('Squat')
    ),
    'juggles' => array (
      '#type'  => 'textfield',
      '#title' => t ('Juggles')
    ),
    'submit' => array (
      '#type'  => 'submit',
      '#value' => 'Save'
  ));
}

/**
  @brief Processes the Player Fitness Stats form.
*/
function soccer_boss_pfs_form_submit ($form, &$form_state) {
  module_load_include ('inc', 'soccer_boss');
  module_load_include ('inc', 'soccer_boss', 'soccer_boss.field');

  foreach (array (
    'Mile Time'            => t ('Mile Time'),
    'Two Mile Time'        => t ('Two Mile Time'),
    'Beep Test'            => t ('Beep Test'),
    'Dash Time'            => t ('Dash Time'),
    'Push-Ups per Minute'  => t ('Push-Ups per Minute'),
    'Sit-Ups per Minute'   => t ('Sit-Ups per Minute'),
    'Bench Press'          => t ('Bench Press'),
    'Squat'                => t ('Squat'),
    'Juggles'              => t ('Juggles')
  ) as $stat_name => $stat_label) {
    $node = new stdClass ();
    $node->type = soccer_boss_PFS_TYPE;
    node_object_prepare ($node);

    $node->title = $stat_label;
    $node->soccer_boss_pfs_player ['und'][0]['target_id'] = $form_state ['values']['player'];
    $node->soccer_boss_pfs_value  ['und'][0] = array (
      'value'  => $form_state ['values'][$stat_name],
      'format' => 'plain_text'
    );

    $date = date_parse ($form_state ['values']['date']);
    $node->soccer_boss_pfs_date ['und'][0] = soccer_boss_create_date_field_value ($date ['year'], $date ['month'], $date ['day']);

    node_save ($node);
  }
}
