<?php
/**
  @file
*/

/// Implements hook_view_api ().
function soccer_boss_views_api () {
  return array ('api' => 3.0);
}

/**
  @brief Implements hook_block_info_alter ().
  @details
    Enables the core blocks and moves them to their
    designated regions.
  @see soccer_boss_block_settings ().
  @see soccer_boss_set_block_visibilities ().
*/
function soccer_boss_block_info_alter (&$blocks, $theme, $code_blocks) {
  module_load_include ('inc', 'soccer_boss');

  foreach (soccer_boss_block_settings () as $delta => $settings) {
    $module = $settings ['module'];

// A source of aggravation!
/*

    if (empty ($blocks [$module][$delta]['pages'])) {
      $blocks [$module][$delta]['status']     = 1;
      $blocks [$module][$delta]['region']     = $settings ['region'];
      $blocks [$module][$delta]['visibility'] = 1;

      $blocks [$module][$delta]['pages'] = isset ($settings ['pages']) ? $settings ['pages'] : 'node/*';

      if (isset ($settings ['weight'])) {
        $blocks [$module][$delta]['weight']   = $settings ['weight'];
      }
    }
*/
  }
}

/// Implements hook_menu ().
function soccer_boss_menu () {
  return array (
    // I. Player pages.
    'node/%node/team' => array (
      'title'            => t ('Team'),
      'description'      => t ('Redirects the user to the player\'s team page.'),
      'access callback'  => '_soccer_boss_check_type',
      'access arguments' => array (1, 'soccer_boss_player'),
      'page callback'    => 'soccer_boss_player_team_page',
      'page arguments'   => array (1),
      'type'             => MENU_LOCAL_TASK,
      'file'             => 'soccer_boss.page.inc',
      'weight'           => 1
    ),
    'player-comparison' => array (
      'title'            => t ('Player Comparison'),
      'description'      => t ('Displays two players side-by-side for comparison.'),
      'access callback'  => true,
      'page callback'    => 'soccer_boss_player_comparison',
      'page arguments'   => array (1, 2),
      'type'             => MENU_CALLBACK,
      'file'             => 'soccer_boss.page.inc',
    ),
    'node/%node/bio' => array (
      'title'            => t ('Player Bio'),
      'description'      => t ('The player bio page.'),
      'access callback'  => '_soccer_boss_check_type',
      'access arguments' => array (1, 'soccer_boss_player'),
      'page callback'    => 'soccer_boss_player_bio_page',
      'page arguments'   => array (1),
      'type'             => MENU_LOCAL_TASK,
      'file'             => 'soccer_boss.page.inc',
      'weight'           => 5
    ),
    'node/%node/fitness' => array (
      'title'            => t ('Player Fitness'),
      'description'      => t ('Displays the player fitness stats.'),
      'access callback'  => '_soccer_boss_check_type',
      'access arguments' => array (1, 'soccer_boss_player'),
      'page callback'    => 'soccer_boss_player_fitness_page',
      'page arguments'   => array (1),
      'type'             => MENU_LOCAL_TASK,
      'file'             => 'soccer_boss.page.inc',
      'weight'           => 6
    ),
    // II. Team pages.
    'node/%node/overview' => array (
      'title'            => t ('Team Overview'),
      'description'      => t ('The team overview page.'),
      'access callback'  => '_soccer_boss_check_type',
      'access arguments' => array (1, 'soccer_boss_team'),
      'page callback'    => 'soccer_boss_team_overview_page',
      'page arguments'   => array (1),
      'type'             => MENU_LOCAL_TASK,
      'file'             => 'soccer_boss.page.inc',
      'weight'           => 6
    ),
    'team-comparison' => array (
      'title'            => t ('Team Comparison'),
      'description'      => t ('Displays two teams side-by-side for comparison.'),
      'access callback'  => true,
      'page callback'    => 'soccer_boss_team_comparison',
      'page arguments'   => array (1, 2),
      'type'             => MENU_CALLBACK,
      'file'             => 'soccer_boss.page.inc',
    ),
    'node/%node/team-player-stats' => array (
      'title'            => t ('Player Performance Stats'),
      'description'      => t ('Displays the performance stats for each player on the team.'),
      'access callback'  => '_soccer_boss_check_type',
      'access arguments' => array (1, 'soccer_boss_team'),
      'page callback'    => 'soccer_boss_team_player_stats_page',
      'page arguments'   => array (1),
      'type'             => MENU_LOCAL_TASK,
      'file'             => 'soccer_boss.page.inc'
    ),
    'node/%node/team-player-game-stats' => array (
      'title'            => t ('Player Game Stats'),
      'description'      => t ('Displays the game stats for each player on the team.'),
      'access callback'  => '_soccer_boss_check_type',
      'access arguments' => array (1, 'soccer_boss_team'),
      'page callback'    => 'soccer_boss_team_player_game_stats_page',
      'page arguments'   => array (1),
      'type'             => MENU_LOCAL_TASK,
      'file'             => 'soccer_boss.page.inc'
    ),
    'node/%node/add-team-player-stats' => array (
      'title'            => t ('Add Player Performance Stats'),
      'description'      => t ('Displays a form in which player performance stats can be added.'),
      'access callback'  => '_soccer_boss_check_type',
      'access arguments' => array (1, 'soccer_boss_team', 'create any soccer_boss_pps content'),
      'page callback'    => 'drupal_get_form',
      'page arguments'   => array ('soccer_boss_team_player_stats_form', 1),
      'type'             => MENU_LOCAL_TASK,
      'file'             => 'soccer_boss.page.inc',
    ),
/*
    'node/%node/add-team-stats' => array (
      'title'            => t ('Add Team Stats'),
      'description'      => t ('Displays a form to enter team stats.'),
      'access callback'  => '_soccer_boss_check_type',
      'access arguments' => array (1, 'soccer_boss_team', 'create any soccer_boss_pps content'),
      'page callback'    => '',
      'page arguments'   => array (1),
      'type'             => MENU_LOCAL_TASK,
      'file'             => 'soccer_boss.page.inc'
    ),
*/
    'node/%node/add-team-player-game-stats' => array (
      'title'            => t ('Add Player Game Stats'),
      'description'      => t ('Displays a form to enter player game stats.'),
      'access callback'  => '_soccer_boss_check_type',
      'access arguments' => array (1, 'soccer_boss_team', 'create any soccer_boss_pps content'),
      'page callback'    => 'drupal_get_form',
      'page arguments'   => array ('soccer_boss_team_player_game_stats_form', 1),
      'type'             => MENU_LOCAL_TASK,
      'file'             => 'soccer_boss.page.inc'
    ),
    'player-comparison-form' => array (
      'title'            => t ('Player Comparison'),
      'description'      => t ('Lets users select players to compare.'),
      'access callback'  => true,
      'page callback'    => 'drupal_get_form',
      'page arguments'   => array ('soccer_boss_player_comparison_form'),
      'type'             => MENU_NORMAL_ITEM
    ),
    'team-comparison-form' => array (
      'title'            => t ('Team Comparison'),
      'description'      => t ('Lets users select teams to compare.'),
      'access callback'  => true,
      'page callback'    => 'drupal_get_form',
      'page arguments'   => array ('soccer_boss_team_comparison_form'),
      'type'             => MENU_NORMAL_ITEM
    ),
    'team-player-stats-form/%' => array (
      'title'            => t ('Team Player Stats'),
      'description'      => t ('The Team Player Stats form.'),
      'access callback'  => true,
      'page callback'    => 'drupal_get_form',
      'page arguments'   => array ('soccer_boss_team_player_stats_form', 1),
      'type'             => MENU_NORMAL_ITEM
    ),
    'node/%node/add-player-fitness-stats' => array (
      'title'            => t ('Add Player Fitness Stats'),
      'description'      => t ('Displays a form in which a player can add fitness stats.'),
      'access callback'  => '_soccer_boss_check_type',
      'access arguments' => array (1, 'soccer_boss_player', 'create any soccer_boss_pps content'),
      'page callback'    => 'drupal_get_form',
      'page arguments'   => array ('soccer_boss_pfs_form', 1),
      'type'             => MENU_LOCAL_TASK
    )
  );
}

/**
  @brief Defines a menu access callback that
    returns true iff the given node has the given
    type.
  @param $node (object) the referenced node.
  @param $type (string) the required node type.
  @param $privilege (string) an optional privilege to check.
  @return (boolean).
*/
function _soccer_boss_check_type ($node, $type, $privilege = false) {
  return $node->type == $type && ($privilege ? user_access ($privilege) : true);
}

// ----- II. Comparison Forms ----- 

/**
  @brief
    Returns the Player Comparison form. The form is
    used to select players to compare on the player
    comparison page.
*/
function soccer_boss_player_comparison_form ($form, &$form_state) {
  module_load_include ('inc', 'soccer_boss');

  return array (
    'player_x' => array (
      '#type'            => 'entityreference',
      '#title'           => t ('First Player'),
      '#era_entity_type' => 'node',
      '#era_bundles'     => array (soccer_boss_PLAYER_TYPE),
      '#era_cardinality' => 1
    ),
    'player_y' => array (
      '#type'            => 'entityreference',
      '#title'           => t ('Second Player'),
      '#era_entity_type' => 'node',
      '#era_bundles'     => array (soccer_boss_PLAYER_TYPE),
      '#era_cardinality' => 1
    ),
    'submit' => array (
      '#type'  => 'submit',
      '#value' => 'Compare!'
    )
  );
}

/**
  @brief Processes a Player Comparison Form
    submission and redirects the user to the Player
    Comparison Page.
*/
function soccer_boss_player_comparison_form_submit ($form, &$form_state) {
  drupal_goto ('player-comparison/' . 
    $form_state ['values']['player_x']['entity_id'] . '/' .
    $form_state ['values']['player_y']['entity_id']
  );
}

/**
  @brief
    Returns the Team Comparison form. The form is
    used to select teams to compare on the Team 
    Comparison page.
*/
function soccer_boss_team_comparison_form ($form, &$form_state) {
  module_load_include ('inc', 'soccer_boss');

  return array (
    'team_x' => array (
      '#type'            => 'entityreference',
      '#title'           => t ('First Team'),
      '#era_entity_type' => 'node',
      '#era_bundles'     => array (soccer_boss_TEAM_TYPE),
      '#era_cardinality' => 1
    ),
    'team_y' => array (
      '#type'            => 'entityreference',
      '#title'           => t ('Second Team'),
      '#era_entity_type' => 'node',
      '#era_bundles'     => array (soccer_boss_TEAM_TYPE),
      '#era_cardinality' => 1
    ),
    'submit' => array (
      '#type'  => 'submit',
      '#value' => 'Compare!'
    )
  );
}

/**
  @brief Processes a Team Comparison Form
    submission and redirects the user to the Team
    Comparison Page.
*/
function soccer_boss_team_comparison_form_submit ($form, &$form_state) {
  drupal_goto ('team-comparison/' . 
    $form_state ['values']['team_x']['entity_id'] . '/' .
    $form_state ['values']['team_y']['entity_id']
  );
}

// ----- III. Stat Sheets -----

/**
  @brief Creates a stat sheet organized into a spreadsheet
  @param $info (array) the spreadsheet description.
  @note $info has the following structure:
    array (
      'columns'  => array (<stat name> => <header label>, ...)
      'entities' => array (<entity>, ...)
    )
*/
function soccer_boss_create_stat_sheet ($info) {
  // I. Define the table headers.
  $prefix = '<table><thead><tr><th>Name</th>';
  foreach (array_values ($info ['columns']) as $label) {
    $prefix .= "<th>$label</th>";
  }
  $prefix .= '</tr></thead><tbody>';

  $form = array (
    '#prefix'     => $prefix,
    '#suffix'     => '</tbody></table>',
    '#attributes' => array (
      'class' => array ('statsheet-table')
    )
  );

  // II. Define the table rows.
  foreach ($info ['entities'] as $entity) {
    $entity_id    = entity_id    ('node', $entity);
    $entity_label = entity_label ('node', $entity);
    $entity_uri   = entity_uri   ('node', $entity);

    // II.A. Define the table row.
    $form [$entity_id . '_row'] = array (
      '#prefix'     => '<tr><td>' . l ($entity_label, $entity_uri ['path']) . '</td>',
      '#suffix'     => '</tr>',
      '#attributes' => array (
        'class' => array ('statsheet-row')
      )
    );

    // II.B. Define table cells.
    foreach (array_keys ($info ['columns']) as $stat_name) {
      $form [$entity_id . '_row'][$entity_id . '_' . $stat_name] = array (
        '#prefix'     => '<td>',
        '#suffix'     => '</td>',
        '#type'       => 'textfield',
        '#attributes' => array (
          'class' => array ('statsheet-cell')
        )
      ); 
    }
  }

  $form ['submit'] = array (
    '#type'  => 'submit',
    '#value' => 'Save'
  );

  return $form;
}

/**
  @brief Accepts a stat sheet form and creates
    stats for the values listed in the form.
  @param $form_values (array) the form values.
*/
function soccer_boss_process_stat_sheet ($info, $form_values) {
  $values = array ();
  foreach ($info ['entities'] as $entity) {
    $entity_id = entity_id ('node', $entity);

    foreach ($form_values as $key => $value) {
      if (0 === strpos ($key, $entity_id, 0) && $value !== '') {
        $i = strpos ($key, '_', 0);
        $stat_name = substr ($key, $i + 1);
        $values [$entity_id][$stat_name] = array (
          'label' => $info ['columns'][$stat_name],
          'value' => $value
        );
      }
    }
  }
  return $values;
}

/**
  @brief Creates the Team Player Stats form.
  @param $form (array) the initial form.
  @param $form_state (array) the initial form state.
  @param $team (node) the team node.
  @return (array) the form array.
*/
function soccer_boss_team_player_stats_form ($form, &$form_state, $team) {
  module_load_include ('inc', 'soccer_boss');

  $player_nids = soccer_boss_get_references (
    $team->nid,
    'node',
    'soccer_boss_player_team'
  );

  $info = array (
    'columns' => array (
      'goals'         => 'Goals',
      'shots'         => 'Shots',
      'goal_shots'    => 'Shots on Goal',
      'shots_against' => 'Shots Against',
      'assists'       => 'Assists',
      'yellow_cards'  => 'Yellow Cards',
      'red_cards'     => 'Red Cards',
      'shutouts'      => 'Shutouts'
    ),
    'entities' => node_load_multiple ($player_nids)
  );

  $form_state ['soccer_boss_info'] = $info;

  $form = array (
    'year' => array (
      '#type'            => 'textfield',
      '#title'           => t ('Year'),
      '#required'        => true
  ));
  $form += soccer_boss_create_stat_sheet ($info);
  return $form;
}

/**
  @brief Processes the Team Player Stats form.
*/
function soccer_boss_team_player_stats_form_submit ($form, $form_state) {
  $values = soccer_boss_process_stat_sheet (
    $form_state ['soccer_boss_info'],
    $form_state ['values']
  );

  foreach ($values as $entity_id => $stat_values) {
    foreach ($stat_values as $stat_name => $stat_value) {
      $node = new stdClass ();
      $node->type = soccer_boss_PPS_TYPE;
      node_object_prepare ($node);

      $node->title = $stat_value ['label'];
      $node->soccer_boss_pps_player ['und'][0]['target_id'] = $entity_id;
      $node->soccer_boss_pps_year   ['und'][0] = array (
        'value'  => $form_state ['values']['year'],
        'format' => 'plain_text'
      );
      $node->soccer_boss_pps_value  ['und'][0] = array (
        'value'  => $stat_value ['value'],
        'format' => 'plain_text'
      );

      node_save ($node);
    }
  }
}

/**
  @brief Creates the Team Player Game Stats form.
  @param $form (array) the initial form.
  @param $form_state (array) the initial form state.
  @param $team (node) the team node.
  @return (array) the form array.
*/
function soccer_boss_team_player_game_stats_form ($form, &$form_state, $team) {
  module_load_include ('inc', 'soccer_boss');

  $player_nids = soccer_boss_get_references (
    $team->nid,
    'node',
    'soccer_boss_player_team'
  );

  $info = array (
    'columns' => array (
      'goals'         => 'Goals',
      'shots'         => 'Shots',
      'goal_shots'    => 'Shots on Goal',
      'shots_against' => 'Shots Against',
      'assists'       => 'Assists',
      'yellow_cards'  => 'Yellow Cards',
      'red_cards'     => 'Red Cards',
      'shutouts'      => 'Shutouts'
    ),
    'entities' => node_load_multiple ($player_nids)
  );

  $form_state ['soccer_boss_info'] = $info;

  $form = array (
    'game' => array (
      '#type'            => 'entityreference',
      '#title'           => t ('Game'),
      '#era_entity_type' => 'node',
      '#era_bundles'     => array (soccer_boss_GAME_TYPE),
      '#era_cardinality' => 1
  ));
  $form += soccer_boss_create_stat_sheet ($info);
  return $form;
}

/**
  @brief Processes the Team Player Game Stats form.
*/
function soccer_boss_team_player_game_stats_form_submit ($form, $form_state) {
  $values = soccer_boss_process_stat_sheet (
    $form_state ['soccer_boss_info'],
    $form_state ['values']
  );

  foreach ($values as $entity_id => $stat_values) {
    foreach ($stat_values as $stat_name => $stat_value) {
      $node = new stdClass ();
      $node->type = soccer_boss_PGS_TYPE;
      node_object_prepare ($node);

      $node->title = $stat_value ['label'];
      $node->soccer_boss_pgs_player ['und'][0]['target_id'] = $entity_id;
      $node->soccer_boss_pgs_game   ['und'][0]['target_id'] = $form_state ['values']['game']['entity_id'];
      $node->soccer_boss_pgs_value  ['und'][0] = array (
        'value'  => $stat_value ['value'],
        'format' => 'plain_text'
      );

      node_save ($node);
    }
  }
}

/**
  @brief Defines the Player Fitness Stats form.
*/
function soccer_boss_pfs_form ($form, $form_state, $player_node) {
  return array (
    'player' => array (
      '#type'  => 'value',
      '#value' => $player_node->nid
    ),
    'date' => array (
      '#type'          => 'textfield',
      '#title'         => t ('Date'),
      '#description'   => t ('The Date on which these stats were measured or applied.'),
      '#default_value' => date ('D, d M Y H:i:s'),
      '#required'      => true
    ),
    'mile_time' => array (
      '#type'  => 'textfield',
      '#title' => t ('Mile Time')
    ),
    'two_mile_time' => array (
      '#type'  => 'textfield',
      '#title' => t ('Two Mile Time')
    ),
    'dash_time' => array (
      '#type'  => 'textfield',
      '#title' => t ('60 yard dash time')
    ),
    'bench_press' => array (
      '#type'  => 'textfield',
      '#title' => t ('Bench press')
    ),
    'squat' => array (
      '#type'  => 'textfield',
      '#title' => t ('Squat')
    ),
    'juggles' => array (
      '#type'  => 'textfield',
      '#title' => t ('Juggles')
    ),
    'submit' => array (
      '#type'  => 'submit',
      '#value' => 'Save'
  ));
}

/**
  @brief Processes the Player Fitness Stats form.
*/
function soccer_boss_pfs_form_submit ($form, &$form_state) {
  module_load_include ('inc', 'soccer_boss');
  module_load_include ('inc', 'soccer_boss', 'soccer_boss.field');

  foreach (array (
    'mile_time'     => t ('Mile Time'),
    'two_mile_time' => t ('Two Mile Time'),
    'dash_time'     => t ('Dash Time'),
    'bench_press'   => t ('Bench Press'),
    'squat'         => t ('Squat'),
    'juggles'       => t ('Juggles')
  ) as $stat_name => $stat_label) {
    $node = new stdClass ();
    $node->type = soccer_boss_PFS_TYPE;
    node_object_prepare ($node);

    $node->title = $stat_label;
    $node->soccer_boss_pfs_player ['und'][0]['target_id'] = $form_state ['values']['player'];
    $node->soccer_boss_pfs_value  ['und'][0] = array (
      'value'  => $form_state ['values'][$stat_name],
      'format' => 'plain_text'
    );

    $date = date_parse ($form_state ['values']['date']);
    $node->soccer_boss_pfs_date ['und'][0] = soccer_boss_create_date_field_value ($date ['year'], $date ['month'], $date ['day']);

    node_save ($node);
  }
}

// ----- Chart functions -----

/// The AJAX callback for the Next button in the Chart form.
function _soccer_boss_next_chart () {
  array_push ($_SESSION ['soccer_boss']['chart_data'],
              array_shift ($_SESSION ['soccer_boss']['chart_data']));

  return drupal_get_form ('soccer_boss_chart_form');
}

/// The AJAX callback for the Previous button in the Chart form.
function _soccer_boss_prev_chart () {
  array_unshift ($_SESSION ['soccer_boss']['chart_data'],
                 array_pop ($_SESSION ['soccer_boss']['chart_data']));

  return drupal_get_form ('soccer_boss_chart_form');
}

/**
  @brief Accepts a chart value along with the
    minimum and maximum value displayed on the
    chart and returns the scaled equivalent of the
    given value.
  @param $min (float) the minimum chart value.
  @param $max (float) the maximum chart value.
  @param $value (float) the unscaled chart value.
  @return (float) the scaled chart value.
  @note Google Charts only allows values between
    0 - 100 inclusive.
*/
function _soccer_boss_get_scaled_value ($min, $max, $value) {
  return $max - $min > 0 ? (($value - $min)/($max - $min)) * 100 : 0;
}

/**
  @brief Accepts a raw unscaled chart value and
    converts the value into a float that can be
    scaled.
  @param $value (string) the raw chart value.
  @return (float) the converted chart value.
  @note This function tries to convert time
    measures into second counts and strips units
    from unit measures.
*/
function _soccer_boss_convert_value ($value) {
  if (preg_match ('/\s*(\d?\d):(\d\d)\s*/', $value, $matches)) {
    $value = $matches [1] * 60 + $matches [2];
  } else if (preg_match ('/^(\d+)/', $value, $matches)) { // strip units.
    $value = $matches [1];
  }
  return $value;
}

/**
  @brief Accepts raw unscaled chart values and
    converts the values into floats that can be
    scaled.
  @param $values (array) the raw chart values.
  @return (array) the converted chart values.
*/
function _soccer_boss_convert_values ($values) {
  return array_map ('_soccer_boss_convert_value', $values);
}

/**
  @brief Accepts an array of chart values and
    returns their scaled equivalents.
  @param $values (array) the values.
  @return (array) the scaled values.
*/
function _soccer_boss_scale_chart_values ($values) {
  $scaled_values = array ();

  $min = min ($values);
  $max = max ($values);

  foreach ($values as $value) {
    $scaled_values [] = _soccer_boss_get_scaled_value ($min, $max, $value);
  }

  return $scaled_values;
}

/**
  @brief Accepts an array of unscaled chart values
    and returns the chart value labels for the
    y-axis.
  @param $values (array) the unscaled values.
  @return (array) the chart labels.
*/
function _soccer_boss_get_chart_value_labels ($values) {
  $labels = array ();

  $unique_values = array_unique ($values);  
  $min   = min ($unique_values);
  $max   = max ($unique_values);

  foreach ($unique_values as $unique_value) {
    $labels [] = chart_mixed_axis_label ($unique_value, _soccer_boss_get_scaled_value ($min, $max, $unique_value));
  }

  return $labels;
}

/**
  @brief Returns a Chart that represents the given data.
  @param $data (array) the chart data array.
*/
function _soccer_boss_create_chart ($data) {
  $y_axis_values = array_unique ($data ['values']);
  $x_axis_values = array_unique ($data ['x_axis_values']);

  return array (
    '#chart_id'           => $data ['chart_id'],
    '#title'              => $data ['title'],
    '#type'               => $data ['type'],
    '#size'               => $data ['size'],
    '#adjust_resolution'  => true,
    '#legends'            => array ($data ['legend']),
    '#mixed_axis_labels'  => array (
      CHART_AXIS_Y_LEFT   => array (
        _soccer_boss_get_chart_value_labels ($y_axis_values),
        chart_mixed_axis_label ($data ['y_axis_label'], 50)
      ),
      CHART_AXIS_X_BOTTOM => array (
        array_map ('chart_mixed_axis_label', $x_axis_values),
        chart_mixed_axis_label ($data ['x_axis_label'], 50)
      )
    ),
    '#data'               => array (
      'values'            => _soccer_boss_scale_chart_values (
                               _soccer_boss_convert_values ($data ['values']))
  ));
}

/**
  @brief Returns a form that allows users to cycle through charts.
  @return (array) the form array.
  @note The charts are defined by the
    $_SESSION ['soccer_boss']['chart_data'] session variable.
*/
function soccer_boss_chart_form ($form, $form_state) {
  $data = $_SESSION ['soccer_boss']['chart_data'];

  if (empty ($data)) { return array (); }

  $chart = _soccer_boss_create_chart ($data [0]);

  return array (
    'pager' => array (
      '#type' => 'fieldset',
      '#prefix' => '<div id="soccer_boss_fitness_chart">' . theme ('chart', array ('chart' => $chart)),
      '#suffix' => '</div>',

      'next_button' => array (
        '#type'  => 'button',
        '#value' => t ('Next'),
        '#ajax'  => array (
          'callback' => '_soccer_boss_next_chart',
          'wrapper'  => 'soccer_boss_fitness_chart'
      )),
      'prev_button' => array (
        '#type'  => 'button',
        '#value' => t ('Prev'),
        '#ajax'  => array (
          'callback' => '_soccer_boss_prev_chart',
          'wrapper'  => 'soccer_boss_fitness_chart'
      ))
    )
  );
}
